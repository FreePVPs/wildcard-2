      const int rank_jk = j+k<n ? rank[j+k] : -1;