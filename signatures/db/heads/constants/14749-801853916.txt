      const int rank_ik = i+k<n ? rank[i+k] : -1;